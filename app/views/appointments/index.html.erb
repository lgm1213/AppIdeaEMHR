<% content_for :title, "Schedule" %>

<div class="flex flex-col h-[calc(100vh-100px)]">
  
  <div class="flex items-center justify-between mb-6">
    <div class="flex items-center gap-4">
      <h1 class="text-2xl font-bold text-gray-900">
        <%= @target_date.strftime("%A, %b %d") %>
      </h1>
      <div class="flex rounded-md shadow-sm">
        <%= link_to "←", 
          appointments_path(slug: @current_organization.slug, date: @target_date - 1.day), 
          class: %w[
            relative inline-flex items-center rounded-l-md bg-white px-3 py-2 
            text-sm font-semibold text-gray-900 
            ring-1 ring-inset ring-gray-300 
            hover:bg-gray-50 
            focus:z-10
            ].join(" ") 
        %>
        <%= link_to "Today", 
          appointments_path(slug: @current_organization.slug, date: Date.current), 
          class: %w[
            relative -ml-px inline-flex items-center bg-white px-3 py-2 
            text-sm font-semibold text-gray-900 
            ring-1 ring-inset ring-gray-300 
            hover:bg-gray-50 
            focus:z-10
            ].join(" ") 
        %>
        <%= link_to "→", 
          appointments_path(slug: @current_organization.slug, date: @target_date + 1.day), 
          class: %w[
            relative -ml-px inline-flex items-center 
            rounded-r-md bg-white px-3 py-2 
            text-sm font-semibold text-gray-900 
            ring-1 ring-inset ring-gray-300 
            hover:bg-gray-50 
            focus:z-10
            ].join(" ") 
        %>
      </div>
    </div>
    <%= link_to "New Appointment", 
      new_appointment_path(slug: @current_organization.slug), 
      class: "rounded-md bg-indigo-600 px-3.5 py-2.5 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500" 
    %>
  </div>

  <div class="flex flex-1 gap-6 overflow-hidden">
    
    <div class="w-1/3 bg-white rounded-lg shadow border border-gray-200 flex flex-col">
      <div class="p-4 border-b border-gray-200 bg-gray-50">
        <h2 class="font-semibold text-gray-900">Agenda for <%= @target_date.strftime("%A") %></h2>
      </div>
      
      <div class="overflow-y-auto flex-1 p-4 space-y-3">
        <% @days_appointments.each do |appt| %>
          <div class="group relative flex items-start space-x-3 ...">
            <div class="min-w-0 flex-1">
              <div class="mt-2 flex gap-2">
                <% if appt.completed? %>
                    <span class="text-xs text-green-600 font-medium flex items-center">
                      ✓ Visit Completed
                    </span>
                <% else %>
                    <%= link_to new_patient_encounter_path(slug: @current_organization.slug, patient_id: appt.patient_id, appointment_id: appt.id), 
                        class: "inline-flex items-center rounded bg-indigo-50 px-2 py-1 text-xs font-medium text-indigo-700 hover:bg-indigo-100 ring-1 ring-inset ring-indigo-700/10" do %>
                      Start Visit
                    <% end %>
                <% end %>
              </div>
            </div>

            <%= link_to "Edit", edit_appointment_path(appt, slug: @current_organization.slug) %>
          </div>
        <% end %>
        
        <% if @days_appointments.empty? %>
          <div class="text-center py-10">
            <p class="text-sm text-gray-500">No appointments scheduled for today.</p>
          </div>
        <% end %>
      </div>
    </div>

    <div class="w-2/3 bg-white rounded-lg shadow border border-gray-200 flex flex-col">
      <div class="p-4 border-b border-gray-200 bg-gray-50 flex justify-between items-center">
        <h2 class="font-semibold text-gray-900">Week of <%= @start_of_week.strftime("%b %d") %></h2>
        <div class="text-xs text-gray-500 flex gap-2">
          <span class="flex items-center gap-1"><span class="w-3 h-3 bg-blue-100 border border-blue-200 rounded"></span> Scheduled</span>
          <span class="flex items-center gap-1"><span class="w-3 h-3 bg-green-100 border border-green-200 rounded"></span> Checked In</span>
        </div>
      </div>
      
      <div class="flex-1 overflow-y-auto p-4">
        <div class="grid grid-cols-5 gap-2 h-full">
          <% (@start_of_week..(@start_of_week + 4.days)).each do |date| %>
            <div class="flex flex-col h-full">
              <div class="text-center mb-2 pb-2 border-b border-gray-100 <%= 'bg-indigo-50 rounded text-indigo-700 font-bold' if date == @target_date %>">
                <span class="block text-xs font-medium text-gray-500"><%= date.strftime("%a") %></span>
                <span class="block text-lg font-bold text-gray-900"><%= date.day %></span>
              </div>
              
              <div class="space-y-2 bg-gray-50 flex-1 rounded p-1">
                <% day_appts = @weeks_appointments.select { |a| a.start_time.to_date == date } %>
                <% day_appts.each do |appt| %>
                  <% color_class = appt.checked_in? ? "bg-green-100 border-green-200 text-green-800" : "bg-blue-50 border-blue-200 text-blue-700" %>
                  <%= link_to appointment_path(appt, slug: @current_organization.slug), 
                    class: "block p-1.5 rounded border text-xs mb-1 hover:shadow-sm transition #{color_class}" do 
                  %>
                    <div class="font-bold"><%= appt.start_time.strftime("%l:%M") %></div>
                    <div class="truncate"><%= appt.patient.last_name %></div>
                  <% end %>
                <% end %>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    </div>

  </div>
</div>