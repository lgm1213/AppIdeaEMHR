<%# Determine the correct URL based on whether we are creating or updating %>
<% form_url = if @encounter.new_record? 
    { controller: 'encounters', action: 'create', slug: @organization.slug } 
  else 
    { controller: 'encounters', action: 'update', id: @encounter.id, slug: @organization.slug } 
  end 
%>

<%= form_with(model: @encounter, 
              url: form_url, 
              id: "encounter-form", 
              class: "space-y-8") do |form| %>

  <%# --- 1. Error Messages --- %>
  <% if @encounter.errors.any? %>
    <div class="bg-red-50 p-4 rounded border border-red-200">
      <h4 class="text-red-800 font-bold mb-2">Please fix the following:</h4>
      <ul class="list-disc ml-5 text-red-600 text-sm">
        <% @encounter.errors.full_messages.each do |msg| %><li><%= msg %></li><% end %>
      </ul>
    </div>
  <% end %>

  <%# --- 2. Header: Patient, Date, Provider --- %>
  <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200 grid grid-cols-1 md:grid-cols-3 gap-6">
    <div>
      <label class="block text-sm font-bold text-gray-700">Patient</label>
      <div class="mt-1 p-2 bg-gray-50 rounded border text-gray-800">
        <%= @encounter.patient&.first_name || "Unknown" %> <%= @encounter.patient&.last_name %>
      </div>
      <%= form.hidden_field :patient_id %>
    </div>

    <div>
      <%= form.label :visit_date, class: "block text-sm font-bold text-gray-700" %>
      <%= form.date_field :visit_date, class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:ring-indigo-500 focus:border-indigo-500" %>
    </div>

    <div>
      <%= form.label :provider_id, "Provider", class: "block text-sm font-bold text-gray-700" %>
      <%= form.collection_select :provider_id, 
          @organization.providers, :id, :display_name, 
          {}, 
          class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:ring-indigo-500 focus:border-indigo-500" %>
    </div>
  </div>

  <%# --- 3. Vitals Section (New) --- %>
  <%= form.fields_for :vital do |v| %>
    <%= render "vitals_fields", f: v %>
  <% end %>

  <%# --- 4. SOAP Note: Subjective & Objective --- %>
  <%# FIXED: Removed the duplicated nesting error here %>
  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
    <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
      <h3 class="text-lg font-bold text-gray-900 mb-4">Subjective</h3>
      <%= form.text_area :subjective, 
          rows: 5, 
          class: "block w-full rounded-md border-gray-300 shadow-sm focus:ring-indigo-500 focus:border-indigo-500", 
          placeholder: "Patient complains of..." 
      %>
    </div>

    <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
      <h3 class="text-lg font-bold text-gray-900 mb-4">Objective</h3>
      <%= form.text_area :objective, 
          rows: 5, 
          class: "block w-full rounded-md border-gray-300 shadow-sm focus:ring-indigo-500 focus:border-indigo-500", 
          placeholder: "Vitals, Exam findings..." 
      %>
    </div>
  </div>

  <%# --- 5. Assessment (Diagnoses) --- %>
  <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
    <h3 class="text-lg font-bold text-gray-900 mb-2">Assessment (Diagnoses)</h3>
    
    <div data-controller="nested-form">
      <div data-nested-form-target="target" class="space-y-3">
        <%= form.fields_for :encounter_diagnoses do |dx| %>
          <%= render "encounter_diagnosis_fields", f: dx %>
        <% end %>
      </div>
      
      <button type="button" data-action="nested-form#add" class="mt-4 text-sm font-medium text-indigo-600 hover:text-indigo-800 flex items-center">
        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
        Add Diagnosis
      </button>

      <template data-nested-form-target="template">
        <%= form.fields_for :encounter_diagnoses, EncounterDiagnosis.new, child_index: 'NEW_RECORD' do |dx| %>
          <%= render "encounter_diagnosis_fields", f: dx %>
        <% end %>
      </template>
    </div>
  </div>

  <%# --- 6. Plan (Procedures) --- %>
  <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
    <h3 class="text-lg font-bold text-gray-900 mb-2">Plan (Procedures)</h3>
    
    <div data-controller="nested-form">
      <div data-nested-form-target="target" class="space-y-3">
        <%= form.fields_for :encounter_procedures do |proc| %>
          <%= render "encounter_procedure_fields", f: proc %>
        <% end %>
      </div>

      <button type="button" data-action="nested-form#add" class="mt-4 inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-indigo-700 bg-indigo-100 hover:bg-indigo-200 focus:outline-none">
        + Add Procedure
      </button>

      <template data-nested-form-target="template">
        <%= form.fields_for :encounter_procedures, EncounterProcedure.new, child_index: 'NEW_RECORD' do |proc| %>
          <%= render "encounter_procedure_fields", f: proc %>
        <% end %>
      </template>
    </div>
  </div>

  <%# --- 7. Finalize Button --- %>
  <div class="pt-4 pb-12">
    <%= form.submit "Finalize Encounter", 
      class: %w[
        w-full flex justify-center py-3 px-4 
        border border-transparent rounded-md shadow-sm 
        text-lg font-medium text-white bg-green-600 
        hover:bg-green-700 
        focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 cursor-pointer
      ].join(" ") 
    %>
  </div>

<% end %>